# Requirements Document

## Introduction

本特性旨在将猪猪养基 H5 应用接入权威第三方基金数据源,支持用户以基金代码快速搜索,并在移动端界面查看实时估值、涨跌幅与更新时间,确保估值信息可信、可追溯并具备高可用性。

## Glossary

- **Authority Provider**: 拥有监管资质的数据供应商(如万得、东方财富、证监会备案渠道)。
- **Fund Estimate**: 第三方提供的基金实时估值净值、涨跌幅等指标。
- **Snapshot Store**: 用于缓存实时估值快照的后端存储(可由 Redis/InfluxDB 提供)。
- **Lookup API**: 后端暴露给前端的基金搜索与估值查询接口。

## Requirements

### R1: 实时基金搜索与展示

**User Story:** 作为关注实时行情的基金投资者,我希望通过输入基金代码或名称快速搜索并查看实时估值,以便在移动端即时判断是否需要操作。

#### Acceptance Criteria

1. WHEN 用户在搜索框输入不少于 2 个字符时,THE 前端系统 SHALL 调用 Lookup API 返回按代码与名称匹配排序的基金建议列表,且响应时间不超过 500ms。
2. WHEN 用户选择某只基金时,THE 前端系统 SHALL 展示基金简称、代码、实时估值、估算涨跌幅、估值更新时间与数据来源标识。
3. WHILE 用户停留在基金详情页时,THE 前端系统 SHALL 每 15 秒无刷新轮询一次估值数据并在有变更时做显式动画提示。
4. IF 第三方数据返回更新时间早于当前时间 5 分钟,THE 前端系统 SHALL 用显著标签提示"数据可能延迟"并展示最后成功更新时间。

### R2: 权威第三方数据接入与配置

**User Story:** 作为后台运维人员,我希望系统从权威第三方 API 获取估值数据并可在配置中切换或拓展供应商,以满足合规与可用性要求。

#### Acceptance Criteria

1. WHEN 后端服务启动时,THE 系统 SHALL 从加密配置中加载主数据源与备用数据源的 API Key、域名、请求频率限制与签名算法。
2. WHEN Lookup API 收到请求时,THE 系统 SHALL 调用主数据源实时接口,并在 2 次连续失败或 1 秒超时后自动切换至备用数据源继续返回数据。
3. IF 所有数据源均不可用,THE 系统 SHALL 返回带有可机器解析错误码的降级响应,并指示前端展示降级提示。
4. WHEN 运维通过配置中心更新数据源参数时,THE 系统 SHALL 在 60 秒内热更新连接设置且无需重启服务。

### R3: 数据质量校验与缓存

**User Story:** 作为平台技术负责人,我希望所有返回的估值数据经过格式与业务校验并合理缓存,以确保信息可信且可支撑高并发访问。

#### Acceptance Criteria

1. WHEN 第三方响应到达时,THE 后端系统 SHALL 校验基金代码、净值、涨跌幅、更新时间字段的存在性与取值范围,并在校验失败时抛出结构化错误。
2. WHEN 校验通过时,THE 后端系统 SHALL 将估值快照写入 Snapshot Store,并设置 10 秒 TTL 供后续相同基金查询复用。
3. WHILE 缓存命中率低于 70% 时,THE 系统 SHALL 通过指标日志输出基金查询分布与缓存命中占比,便于调优。
4. IF Snapshot Store 不可用,THE 系统 SHALL 直接透传第三方最新结果并附带"未缓存"标记,同时发出运维告警。

### R4: 监控、速率与安全控制

**User Story:** 作为平台 SRE,我希望对基金估值查询的速率、错误与延迟有监控与告警,并确保外部接口调用受限速和认证保护。

#### Acceptance Criteria

1. WHEN Lookup API 接口被调用时,THE 系统 SHALL 记录请求来源、基金代码、第三方延迟、缓存命中状态并发送到集中日志与指标系统。
2. WHILE 单个用户在 1 分钟内的估值查询超过 60 次时,THE 系统 SHALL 启用限流策略返回 429 状态并在响应中标记解封倒计时。
3. IF 第三方接口延迟超过 1 秒或错误率 5% 以上持续 3 分钟,THE 系统 SHALL 触发高优先级告警并在运行状态面板展示。
4. WHEN 前端请求 Lookup API 时,THE 系统 SHALL 验证用户身份令牌并仅对已登录用户返回完整估值数据,未登录用户仅可看到模糊结果与登录提示。
